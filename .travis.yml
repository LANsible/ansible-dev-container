dist: trusty
language: minimal
sudo: false

env:
  global:
    - fast_finish: true
    - DOCKER_NAMESPACE=lansible
    - CONTAINER_NAME=ansible-dev-container

services:
  - docker

matrix:
  include:
    - env: ANSIBLE_VERSION=2.2 TAGS="2.2"         # 2.2.x unsupported
    - env: ANSIBLE_VERSION=2.3 TAGS="2.3"         # 2.3.x unsupported
    - env: ANSIBLE_VERSION=2.4 TAGS="2.4"         # 2.4.x unsupported
    - env: ANSIBLE_VERSION=2.5 TAGS="2.5"         # 2.5.x security
    - env: ANSIBLE_VERSION=2.6 TAGS="2.6"         # 2.6.x bugs and security
    - env: ANSIBLE_VERSION=2.7 TAGS="2.7 latest"  # 2.7.x bugs and security
    - env: ANSIBLE_VERSION=2.8 TAGS="2.8 devel"   # Devel branch source install

before_script:
  - docker pull ${DOCKER_NAMESPACE}/${CONTAINER_NAME}:latest

script:
  - |
    for tag in ${TAGS}
    do
      TAG_STRING+="${TAG_STRING} -t ${DOCKER_NAMESPACE}/${CONTAINER_NAME}:${tag}"
    done
    docker build . --build-arg ANSIBLE_VERSION=${ANSIBLE_VERSION} --cache-from ${DOCKER_NAMESPACE}/${CONTAINER_NAME}:latest ${TAG_STRING}
  - docker run ${DOCKER_NAMESPACE}/${CONTAINER_NAME}:${ANSIBLE_VERSION} molecule --help

deploy:
  provider: script
  script: bash deploy/deploy.sh
  on:
    branch: master
  skip_cleanup: true

notifications:
  email:
    on_failure: change
    on_success: never
